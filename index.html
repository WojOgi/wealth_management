<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Tracker - Themed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default (Classic Light) */
            --bg-app: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #f9fafb;
            --bg-hover: #f3f4f6;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #2563eb; /* Blue-600 */
            --accent-hover: #1d4ed8; /* Blue-700 */
            --accent-text: #ffffff;
            --success: #10b981;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-app: #111827;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --bg-hover: #374151;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border-color: #374151;
            --accent-color: #3b82f6;
            --accent-hover: #60a5fa;
            --accent-text: #ffffff;
            --success: #34d399;
        }

        /* Midnight (Deep Blue) */
        [data-theme="midnight"] {
            --bg-app: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --bg-hover: #334155;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --border-color: #334155;
            --accent-color: #8b5cf6; /* Violet */
            --accent-hover: #a78bfa;
            --accent-text: #ffffff;
            --success: #4ade80;
        }

        /* Forest (Green/Nature) */
        [data-theme="forest"] {
            --bg-app: #ecfdf5;
            --bg-card: #ffffff;
            --bg-input: #f0fdf4;
            --bg-hover: #d1fae5;
            --text-main: #064e3b;
            --text-sub: #047857;
            --border-color: #a7f3d0;
            --accent-color: #059669; /* Emerald */
            --accent-hover: #047857;
            --accent-text: #ffffff;
            --success: #16a34a;
        }

        /* Ocean (Teal/Blue) */
        [data-theme="ocean"] {
            --bg-app: #f0f9ff;
            --bg-card: #ffffff;
            --bg-input: #e0f2fe;
            --bg-hover: #bae6fd;
            --text-main: #0c4a6e;
            --text-sub: #0284c7;
            --border-color: #bae6fd;
            --accent-color: #0891b2; /* Cyan */
            --accent-hover: #0e7490;
            --accent-text: #ffffff;
            --success: #0ea5e9;
        }

        /* --- GLOBAL UTILS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-app); 
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s; 
        }
        
        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color);
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }

        .text-main { color: var(--text-main); }
        .text-sub { color: var(--text-sub); }
        
        .input-std { 
            background-color: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border-color); 
            border-radius: 0.25rem; 
            padding: 0.5rem 0.75rem; 
            width: 100%; 
            outline: none;
        }
        .input-std:focus { ring: 2px solid var(--accent-color); border-color: var(--accent-color); }

        .btn-primary {
            background-color: var(--accent-color);
            color: var(--accent-text);
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }

        .fade-in { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* History Mode Styles */
        body.history-mode { border-top: 8px solid #f97316; } 
        
        /* Sortable Headers */
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: var(--bg-hover); }
        
        /* Custom Date Input Styling */
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; filter: invert(0.5); }
        
        /* Loading Spinner */
        #loadingOverlay { backdrop-filter: blur(2px); background: rgba(0,0,0,0.2); }

        /* Preset Chips */
        .preset-chip { 
            display: flex; align-items: center; gap: 4px;
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color); 
            color: var(--text-sub); 
            padding: 4px 8px; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .preset-chip:hover { border-color: var(--accent-color); color: var(--accent-color); }

        /* Clickable Category Cell */
        .cat-cell { cursor: pointer; transition: background-color 0.2s; user-select: none; }
        .cat-cell:hover { background-color: var(--bg-hover); color: var(--accent-color); }

        /* Table Rows */
        tr { border-bottom: 1px solid var(--border-color); }
        tr:last-child { border-bottom: none; }
        
        /* Highlight Classes */
        .hl-green { background-color: rgba(16, 185, 129, 0.1); }
        .hl-yellow { background-color: rgba(245, 158, 11, 0.1); }
        .row-hover:hover { background-color: var(--bg-hover); }

        /* Selects */
        select { background-color: var(--bg-input); color: var(--text-main); }
    </style>
</head>
<body class="p-6">

    <div id="loadingOverlay" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="card p-4 flex items-center gap-3">
            <i class="fas fa-spinner fa-spin text-main text-xl"></i>
            <span class="font-semibold text-main" id="loadingText">Processing...</span>
        </div>
    </div>

    <div class="max-w-[95%] mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-main flex items-center gap-2">
                <i class="fas fa-chart-line" style="color: var(--accent-color)"></i> 
                <span id="pageTitle">My Wealth Tracker</span>
            </h1>
            <p id="pageSubtitle" class="text-sub text-sm">Track savings, real estate, and crypto yields.</p>
        </div>
        
        <div class="flex gap-2 items-center flex-wrap justify-end">
            <button id="btnExitHistory" onclick="exitHistoryMode()" class="hidden bg-orange-600 text-white px-4 py-2 rounded shadow hover:bg-orange-700 font-bold fade-in">
                <i class="fas fa-arrow-left"></i> Return to Current
            </button>

            <div class="flex items-center gap-2 card px-3 py-2">
                <i class="fas fa-palette text-sub"></i>
                <select id="themeSelector" class="bg-transparent font-bold text-main focus:outline-none text-sm" onchange="setTheme(this.value)">
                    <option value="light">Classic</option>
                    <option value="dark">Dark Mode</option>
                    <option value="midnight">Midnight</option>
                    <option value="forest">Forest</option>
                    <option value="ocean">Ocean</option>
                </select>
            </div>

            <div class="flex items-center gap-2 card px-3 py-2">
                <span class="text-sm font-bold text-sub">Base:</span>
                <select id="baseCurrency" class="bg-transparent font-bold text-main focus:outline-none" onchange="renderAll()">
                    <option value="USD">USD</option>
                    <option value="PLN">PLN</option>
                    <option value="SAR">SAR</option>
                </select>
            </div>
            
            <div id="fileControls" class="flex gap-2">
                <button onclick="exportData()" title="Export JSON" class="card px-4 py-2 hover:bg-gray-100 text-sm"><i class="fas fa-download text-main"></i></button>
                <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                <button onclick="document.getElementById('importFile').click()" title="Import JSON" class="card px-4 py-2 hover:bg-gray-100 text-sm"><i class="fas fa-upload text-main"></i></button>
            </div>
        </div>
    </div>

    <div class="max-w-[95%] mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card p-6 border-l-4" style="border-left-color: var(--accent-color)">
            <h3 class="text-sub text-sm uppercase font-semibold">Total Net Worth</h3>
            <div class="mt-2 flex items-baseline">
                <span id="displayTotalWealth" class="text-3xl font-bold text-main fade-in">0.00</span>
                <span id="displayCurrency1" class="ml-2 text-sub">USD</span>
            </div>
        </div>

        <div class="card p-6 border-l-4 border-green-500">
            <h3 class="text-sub text-sm uppercase font-semibold">Est. Monthly Passive Income</h3>
            <div class="mt-2 flex items-baseline">
                <span id="displayTotalIncome" class="text-3xl font-bold text-main fade-in">0.00</span>
                <span id="displayCurrency2" class="ml-2 text-sub">USD</span>
            </div>
        </div>

        <div class="card p-6 relative">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sub text-sm uppercase font-semibold">Exchange Rates (vs USD)</h3>
                <button id="btnFetchRates" onclick="fetchLiveRates()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition" title="Fetch live rates">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                    <label class="text-sub text-xs">1 USD = ? PLN</label>
                    <input type="number" id="ratePLN" step="0.0001" class="input-std" onchange="updateRatesManual()">
                </div>
                <div>
                    <label class="text-sub text-xs">1 USD = ? SAR</label>
                    <input type="number" id="rateSAR" step="0.0001" class="input-std" onchange="updateRatesManual()">
                </div>
            </div>
            <div id="rateInfoText" class="text-[10px] text-sub mt-2 text-right italic">Live Rates</div>
        </div>
    </div>

    <div class="max-w-[95%] mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2">
            
            <div class="card p-6 mb-6">
                
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-main" id="listTitle">Current Assets</h2>
                        <button id="btnSnapshot" onclick="archiveMonth()" class="text-sm border border-indigo-200 text-indigo-500 px-3 py-1 rounded hover:bg-indigo-50 transition">
                            <i class="fas fa-save"></i> Snapshot Month
                        </button>
                    </div>
                    
                    <div class="relative w-full md:w-64">
                        <input type="text" id="searchInput" placeholder="Search name or category..." oninput="renderAll()" 
                            class="input-std pl-9 rounded-full">
                        <i class="fas fa-search absolute left-3 top-2.5 text-sub text-xs"></i>
                    </div>
                </div>

                <form id="assetForm" onsubmit="handleAssetSubmit(event)" class="p-4 rounded mb-6 grid grid-cols-1 md:grid-cols-6 gap-3 items-end border border-dashed border-[var(--border-color)]">
                    <input type="hidden" id="editId" value="">

                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-sub">Category</label>
                        <input type="text" id="inCat" placeholder="e.g. Real Estate" class="input-std" list="catList" required>
                        <datalist id="catList"></datalist>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-sub">Subcategory / Name</label>
                        <input type="text" id="inSub" placeholder="e.g. Apartment 1" class="input-std" required>
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-sub">Currency</label>
                        <select id="inCurr" class="input-std">
                            <option value="PLN">PLN</option>
                            <option value="SAR">SAR</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-sub">Amount</label>
                        <input type="number" id="inAmt" placeholder="0.00" step="0.01" class="input-std" required>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-sub">Yield Type</label>
                        <select id="inYieldType" class="input-std">
                            <option value="none">None</option>
                            <option value="percent_year">% APY (Yearly)</option>
                            <option value="fixed_month">Fixed Amount (Monthly)</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-sub">Yield Value</label>
                        <input type="number" id="inYieldVal" placeholder="0" step="0.01" class="input-std">
                    </div>
                    <div class="md:col-span-2 flex gap-2">
                        <button type="submit" id="btnSubmit" class="btn-primary w-full shadow-sm">Add Asset</button>
                        <button type="button" id="btnCancelEdit" onclick="cancelEdit()" class="hidden bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400 font-bold"><i class="fas fa-times"></i></button>
                    </div>
                </form>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-sub border-b border-[var(--border-color)] text-sm">
                                <th class="p-3 w-10 text-center"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this.checked)" class="cursor-pointer"></th>
                                <th class="p-3 rounded-tl sortable" onclick="setSort('category')">
                                    Category <i id="sortIcon-category" class="fas fa-sort text-xs ml-1 opacity-50"></i>
                                </th>
                                <th class="p-3 sortable" onclick="setSort('subcategory')">
                                    Name <i id="sortIcon-subcategory" class="fas fa-sort text-xs ml-1 opacity-50"></i>
                                </th>
                                <th class="p-3 text-right">Value (Orig)</th>
                                <th class="p-3 text-right sortable" onclick="setSort('valueBase')">
                                    Value (Base) <i id="sortIcon-valueBase" class="fas fa-sort text-xs ml-1 opacity-50"></i>
                                </th>
                                <th class="p-3 text-right font-semibold text-xs whitespace-nowrap">
                                    % of Total
                                </th>
                                <th class="p-3 text-right sortable" onclick="setSort('income')">
                                    Mth. Income <i id="sortIcon-income" class="fas fa-sort text-xs ml-1 opacity-50"></i>
                                </th>
                                <th class="p-3 text-center rounded-tr">Action</th>
                            </tr>
                        </thead>
                        <tbody id="assetTableBody" class="text-sm">
                            </tbody>
                    </table>
                </div>
                <div class="text-xs text-sub mt-2 italic text-center">
                    <i class="fas fa-info-circle"></i> Tip: Click a Category name to select/deselect the entire group.
                </div>
            </div>

             <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-main">History</h2>
                    <button onclick="addHistoricalRecord()" class="text-xs border border-dashed border-[var(--border-color)] text-sub px-3 py-2 rounded hover:bg-[var(--bg-hover)]">
                        <i class="fas fa-plus"></i> Add Past Record
                    </button>
                </div>
                <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                    </div>
             </div>
        </div>

        <div class="lg:col-span-1 flex flex-col gap-6">
            
            <div class="card p-4" style="border: 2px solid var(--border-color);">
                <h3 class="font-bold text-main mb-2 text-center text-sm uppercase">Selection Analysis</h3>
                
                <div id="presetsContainer" class="mb-4 text-center">
                    <div id="presetList" class="flex flex-wrap gap-2 justify-center"></div>
                </div>

                <div class="flex justify-center mb-3">
                    <div class="bg-[var(--bg-input)] p-1 rounded-lg flex text-xs">
                        <button onclick="setChartMode('category')" id="mode-category" class="px-3 py-1 rounded transition font-semibold">By Category</button>
                        <button onclick="setChartMode('item')" id="mode-item" class="px-3 py-1 rounded transition font-semibold">By Item</button>
                    </div>
                </div>

                <div class="text-center mb-2">
                    <span class="text-xs text-sub">Selected Value:</span>
                    <div class="text-2xl font-bold" style="color: var(--accent-color)">
                        <span id="selectionTotal">0.00</span> <span id="selectionCurrency" class="text-sm font-normal text-main">USD</span>
                    </div>
                    <div class="text-xs font-semibold mt-1" style="color: var(--text-sub)" id="selectionShareText">
                        (0.00% of Total Net Worth)
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4 p-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-input)]">
                    <div class="text-center border-r border-[var(--border-color)]">
                        <div class="text-[10px] text-sub uppercase font-semibold">Yearly Yield</div>
                        <div class="text-sm font-bold" style="color: var(--success)"><span id="selYearly">0.00</span></div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] text-sub uppercase font-semibold">Daily Yield</div>
                        <div class="text-sm font-bold" style="color: var(--success)"><span id="selDaily">0.00</span></div>
                    </div>
                </div>
                
                <div class="relative h-48 w-full mb-4">
                    <canvas id="selectionChart"></canvas>
                </div>

                <div class="flex gap-2 items-center border-t border-[var(--border-color)] pt-3">
                    <input type="text" id="newPresetName" placeholder="Save selection as..." class="input-std text-xs py-1">
                    <button onclick="savePreset()" class="text-xs px-3 py-1 rounded transition font-bold" style="background: var(--accent-color); color: var(--accent-text)">Save</button>
                </div>
                
                <p id="selectionHint" class="text-center text-xs text-sub mt-2 italic">Check boxes or click categories to analyze.</p>
            </div>

            <div class="card p-4">
                <h3 class="font-bold text-main mb-4 text-center">Wealth Allocation (Visible)</h3>
                <canvas id="allocationChart"></canvas>
            </div>
            
            <div class="card p-4">
                <h3 class="font-bold text-main mb-4 text-center">Net Worth History</h3>
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE & STATE ---
        const DEFAULT_RATES = { USD: 1, PLN: 4.00, SAR: 3.75 };
        const CHART_COLORS = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', 
            '#6366F1', '#14B8A6', '#F97316', '#84CC16', '#06B6D4', '#64748B'
        ];

        let appData = {
            rates: { ...DEFAULT_RATES },
            liveRates: { ...DEFAULT_RATES },
            lastRateUpdate: null,
            currentAssets: [],
            history: [],
            presets: [],
            theme: 'light' // Default Theme
        };

        // UI State
        let activeSnapshotId = null; 
        let editModeId = null;
        let sortState = { key: 'category', dir: 'asc' };
        let selectedIds = new Set();
        let selectionChartMode = 'category'; 

        // Color Mapping State
        let categoryColorMap = {};

        // Charts
        let allocChart = null;
        let histChart = null;
        let selectChart = null;

        // --- INITIALIZATION ---
        window.onload = async function() {
            const saved = localStorage.getItem('wealthTrackerData');
            if(saved) {
                const loaded = JSON.parse(saved);
                appData = { ...appData, ...loaded };
                if(!appData.liveRates) appData.liveRates = { ...appData.rates };
                if(!appData.presets) appData.presets = [];
                if(!appData.theme) appData.theme = 'light';
            }
            
            appData.rates = { ...appData.liveRates };

            // Apply Saved Theme
            setTheme(appData.theme);
            document.getElementById('themeSelector').value = appData.theme;

            updateRateInputs();
            renderAll();
            renderPresets();

            const now = Date.now();
            if (!appData.lastRateUpdate || (now - appData.lastRateUpdate > 86400000)) {
                await fetchLiveRates();
            }
        };

        // --- THEME LOGIC ---
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            appData.theme = themeName;
            saveData();
            // Re-render charts to update text colors if needed (optional)
            renderAll();
        }

        // --- LOADING SPINNER ---
        function toggleLoading(show, text="Processing...") {
            const el = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            el.classList.toggle('hidden', !show);
        }

        // --- API & RATES ---
        async function fetchLiveRates() {
            const btn = document.getElementById('btnFetchRates');
            if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if(data && data.rates) {
                    appData.liveRates.PLN = data.rates.PLN;
                    appData.liveRates.SAR = data.rates.SAR;
                    appData.lastRateUpdate = Date.now();
                    if(!activeSnapshotId) {
                        appData.rates = { ...appData.liveRates };
                        updateRateInputs();
                    }
                    saveData();
                    renderAll();
                }
            } catch (error) {
                console.error("Live fetch error", error);
            } finally {
                if(btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }
        }

        async function fetchHistoricalRates(dateString) {
            try {
                const url = `https://api.frankfurter.dev/v1/${dateString}?from=USD`;
                const response = await fetch(url);
                if(!response.ok) throw new Error("History API error");
                const data = await response.json();
                if(data && data.rates) {
                    return {
                        USD: 1,
                        PLN: data.rates.PLN || appData.liveRates.PLN,
                        SAR: data.rates.SAR || 3.75 
                    };
                }
            } catch (e) {
                console.warn("Could not fetch history, using live rates as fallback", e);
            }
            return null;
        }

        function updateRateInputs() {
            document.getElementById('ratePLN').value = appData.rates.PLN;
            document.getElementById('rateSAR').value = appData.rates.SAR;
            
            const label = document.getElementById('rateInfoText');
            if(activeSnapshotId) {
                const snap = appData.history.find(h => h.id === activeSnapshotId);
                label.innerText = `Historical Rates: ${new Date(snap.date).toLocaleDateString()}`;
                label.className = "text-[10px] text-orange-600 mt-2 text-right font-bold";
            } else {
                label.innerText = "Live Rates";
                label.className = "text-[10px] text-sub mt-2 text-right italic";
            }
        }

        function updateRatesManual() {
            appData.rates.PLN = parseFloat(document.getElementById('ratePLN').value);
            appData.rates.SAR = parseFloat(document.getElementById('rateSAR').value);
            
            if(activeSnapshotId) {
                const snap = appData.history.find(h => h.id === activeSnapshotId);
                if(snap) {
                    snap.rates = { ...appData.rates };
                    recalculateSnapshotTotal(activeSnapshotId);
                }
            } else {
                appData.liveRates = { ...appData.rates };
            }
            saveData();
            renderAll();
        }

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('wealthTrackerData', JSON.stringify(appData));
        }

        function getBaseCurrency() {
            return document.getElementById('baseCurrency').value;
        }

        function convert(amount, fromCurr, toCurr) {
            const usdVal = amount / appData.rates[fromCurr];
            return usdVal * appData.rates[toCurr];
        }

        function getAssetValueBase(asset, base) {
            return convert(asset.amount, asset.currency, base);
        }

        function getAssetIncomeBase(asset, base) {
            let monthlyIncomeOrig = 0;
            if(asset.yieldType === 'percent_year') {
                monthlyIncomeOrig = (asset.amount * (asset.yieldValue / 100)) / 12;
            } else if (asset.yieldType === 'fixed_month') {
                monthlyIncomeOrig = asset.yieldValue;
            }
            return convert(monthlyIncomeOrig, asset.currency, base);
        }

        // --- COLOR ASSIGNMENT ---
        function updateCategoryColors(assets) {
            const categories = [...new Set(assets.map(a => a.category))].sort();
            categoryColorMap = {};
            categories.forEach((cat, index) => {
                categoryColorMap[cat] = CHART_COLORS[index % CHART_COLORS.length];
            });
        }

        function getCategoryColor(cat) {
            return categoryColorMap[cat] || '#ccc';
        }

        // --- SORTING ---
        function setSort(key) {
            if(sortState.key === key) {
                sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.dir = 'asc';
            }
            renderAll();
        }

        function updateSortIcons() {
            ['category', 'subcategory', 'valueBase', 'income'].forEach(k => {
                const el = document.getElementById('sortIcon-' + k);
                if(el) {
                    el.className = 'fas fa-sort text-xs ml-1 opacity-50 text-sub';
                }
            });
            const activeEl = document.getElementById('sortIcon-' + sortState.key);
            if(activeEl) {
                activeEl.className = sortState.dir === 'asc' 
                    ? 'fas fa-sort-up text-xs ml-1 opacity-100 text-main' 
                    : 'fas fa-sort-down text-xs ml-1 opacity-100 text-main';
            }
        }

        // --- SELECTION LOGIC ---
        function toggleSelect(id, checked) {
            if(checked) selectedIds.add(id);
            else selectedIds.delete(id);
            renderSelectionChart(); 
        }

        function toggleSelectAll(checked) {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const sourceAssets = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;
            
            const visibleAssets = sourceAssets.filter(asset => 
                asset.category.toLowerCase().includes(searchQuery) || 
                asset.subcategory.toLowerCase().includes(searchQuery)
            );

            if(checked) {
                visibleAssets.forEach(a => selectedIds.add(a.id));
            } else {
                visibleAssets.forEach(a => selectedIds.delete(a.id));
            }
            renderAll(); 
        }

        function toggleCategory(catName) {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const sourceAssets = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;

            const catAssets = sourceAssets.filter(a => 
                a.category === catName && 
                (a.category.toLowerCase().includes(searchQuery) || a.subcategory.toLowerCase().includes(searchQuery))
            );
            
            if (catAssets.length === 0) return;

            const allSelected = catAssets.every(a => selectedIds.has(a.id));

            if (allSelected) {
                catAssets.forEach(a => selectedIds.delete(a.id));
            } else {
                catAssets.forEach(a => selectedIds.add(a.id));
            }
            renderAll();
        }

        function setChartMode(mode) {
            selectionChartMode = mode;
            const btnCat = document.getElementById('mode-category');
            const btnItem = document.getElementById('mode-item');
            
            // Basic reset
            btnCat.style.backgroundColor = 'transparent'; btnCat.style.color = 'var(--text-sub)'; btnCat.style.boxShadow = 'none';
            btnItem.style.backgroundColor = 'transparent'; btnItem.style.color = 'var(--text-sub)'; btnItem.style.boxShadow = 'none';

            // Active Style
            const activeBtn = mode === 'category' ? btnCat : btnItem;
            activeBtn.style.backgroundColor = 'var(--bg-card)';
            activeBtn.style.color = 'var(--accent-color)';
            activeBtn.style.boxShadow = '0 1px 3px 0 rgba(0, 0, 0, 0.1)';

            renderSelectionChart();
        }

        // --- PRESETS LOGIC ---
        function savePreset() {
            const nameInput = document.getElementById('newPresetName');
            const name = nameInput.value.trim();
            if(!name) { alert("Please name your preset."); return; }
            if(selectedIds.size === 0) { alert("No assets selected to save."); return; }

            const newPreset = {
                id: Date.now(),
                name: name,
                assetIds: Array.from(selectedIds)
            };
            
            appData.presets.push(newPreset);
            saveData();
            renderPresets();
            nameInput.value = '';
        }

        function loadPreset(id) {
            const preset = appData.presets.find(p => p.id === id);
            if(!preset) return;
            selectedIds = new Set(preset.assetIds);
            renderAll(); 
        }

        function deletePreset(id, event) {
            event.stopPropagation();
            if(!confirm("Delete this preset?")) return;
            appData.presets = appData.presets.filter(p => p.id !== id);
            saveData();
            renderPresets();
        }

        function renderPresets() {
            const container = document.getElementById('presetList');
            container.innerHTML = '';
            
            appData.presets.forEach(p => {
                const chip = document.createElement('div');
                chip.className = "preset-chip";
                chip.onclick = () => loadPreset(p.id);
                chip.innerHTML = `
                    <span>${p.name}</span>
                    <button onclick="deletePreset(${p.id}, event)" class="w-4 h-4 rounded-full hover:bg-[var(--bg-hover)] flex items-center justify-center text-sub hover:text-red-500">
                        <i class="fas fa-times text-[10px]"></i>
                    </button>
                `;
                container.appendChild(chip);
            });
        }

        // --- ASSET MANAGEMENT ---
        function handleAssetSubmit(e) {
            e.preventDefault();
            const rawAsset = {
                id: editModeId ? editModeId : Date.now(),
                category: document.getElementById('inCat').value,
                subcategory: document.getElementById('inSub').value,
                currency: document.getElementById('inCurr').value,
                amount: parseFloat(document.getElementById('inAmt').value),
                yieldType: document.getElementById('inYieldType').value,
                yieldValue: parseFloat(document.getElementById('inYieldVal').value) || 0
            };

            let targetList = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;

            if (editModeId) {
                const index = targetList.findIndex(a => a.id === editModeId);
                if(index !== -1) targetList[index] = rawAsset;
            } else {
                targetList.push(rawAsset);
            }

            if (activeSnapshotId) recalculateSnapshotTotal(activeSnapshotId);

            cancelEdit();
            saveData();
            renderAll();
        }

        function startEditAsset(id) {
            let targetList = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;
                
            const asset = targetList.find(a => a.id === id);
            if(!asset) return;

            document.getElementById('inCat').value = asset.category;
            document.getElementById('inSub').value = asset.subcategory;
            document.getElementById('inCurr').value = asset.currency;
            document.getElementById('inAmt').value = asset.amount;
            document.getElementById('inYieldType').value = asset.yieldType;
            document.getElementById('inYieldVal').value = asset.yieldValue;

            editModeId = id;
            const btn = document.getElementById('btnSubmit');
            btn.innerText = "Update Asset";
            document.getElementById('btnCancelEdit').classList.remove('hidden');

            document.getElementById('assetForm').scrollIntoView({behavior: 'smooth'});
        }

        function cancelEdit() {
            document.getElementById('assetForm').reset();
            editModeId = null;
            const btn = document.getElementById('btnSubmit');
            btn.innerText = "Add Asset";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        function deleteAsset(id) {
            if(!confirm("Remove this asset?")) return;
            if (activeSnapshotId) {
                const snap = appData.history.find(h => h.id === activeSnapshotId);
                snap.assets = snap.assets.filter(a => a.id !== id);
                recalculateSnapshotTotal(activeSnapshotId);
            } else {
                appData.currentAssets = appData.currentAssets.filter(a => a.id !== id);
            }
            if(editModeId === id) cancelEdit();
            selectedIds.delete(id); 
            saveData();
            renderAll();
        }

        function recalculateSnapshotTotal(snapId) {
            const snap = appData.history.find(h => h.id === snapId);
            let totalUSD = 0;
            snap.assets.forEach(a => {
                totalUSD += convert(a.amount, a.currency, 'USD');
            });
            snap.usdValue = totalUSD;
        }

        // --- HISTORY MODE ---
        async function enterHistoryMode(snapId) {
            toggleLoading(true, "Loading Snapshot...");
            activeSnapshotId = snapId;
            cancelEdit();
            selectedIds.clear(); 
            renderPresets(); 
            
            const snap = appData.history.find(h => h.id === snapId);

            if(snap.rates) {
                appData.rates = { ...snap.rates };
            } else {
                const histRates = await fetchHistoricalRates(snap.date.split('T')[0]);
                if(histRates) {
                    snap.rates = histRates;
                    appData.rates = { ...histRates };
                    saveData();
                } else {
                    appData.rates = { ...appData.liveRates };
                }
            }
            
            document.body.classList.add('history-mode');
            const dateStr = new Date(snap.date).toLocaleDateString();
            document.getElementById('pageTitle').innerText = "Editing Snapshot: " + dateStr;
            document.getElementById('pageSubtitle').innerText = "Rates and values reflect this past date.";
            document.getElementById('listTitle').innerText = "Assets in Snapshot (" + dateStr + ")";
            document.getElementById('btnSnapshot').classList.add('hidden');
            document.getElementById('btnExitHistory').classList.remove('hidden');
            
            updateRateInputs();
            renderAll();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            toggleLoading(false);
        }

        function exitHistoryMode() {
            activeSnapshotId = null;
            cancelEdit();
            selectedIds.clear();
            
            appData.rates = { ...appData.liveRates };
            
            document.body.classList.remove('history-mode');
            document.getElementById('pageTitle').innerText = "My Wealth Tracker";
            document.getElementById('pageSubtitle').innerText = "Track savings, real estate, and crypto yields.";
            document.getElementById('listTitle').innerText = "Current Assets";
            document.getElementById('btnSnapshot').classList.remove('hidden');
            document.getElementById('btnExitHistory').classList.add('hidden');
            
            updateRateInputs();
            renderAll();
        }

        async function updateSnapshotDate(id, newDateStr) {
            const snap = appData.history.find(h => h.id === id);
            if(snap && newDateStr) {
                toggleLoading(true, "Fetching historical rates...");
                snap.date = new Date(newDateStr).toISOString();
                
                const newRates = await fetchHistoricalRates(newDateStr);
                if(newRates) {
                    snap.rates = newRates;
                    if(activeSnapshotId === id) {
                        appData.rates = { ...newRates };
                        updateRateInputs();
                    }
                    const tempRates = appData.rates;
                    appData.rates = newRates;
                    recalculateSnapshotTotal(id);
                    appData.rates = tempRates; 
                }

                saveData();
                renderAll(); 
                toggleLoading(false);
            }
        }

        async function addHistoricalRecord() {
            toggleLoading(true, "Creating past record...");
            const d = new Date();
            d.setDate(d.getDate() - 1);
            const dateStr = d.toISOString().split('T')[0];

            const histRates = await fetchHistoricalRates(dateStr) || { ...appData.liveRates };

            const newSnap = {
                id: Date.now(),
                date: d.toISOString(),
                usdValue: 0,
                rates: histRates,
                assets: []
            };
            
            appData.history.push(newSnap);
            saveData();
            
            await enterHistoryMode(newSnap.id);
            toggleLoading(false);
        }

        // --- RENDERING ---
        function renderAll() {
            const base = getBaseCurrency();
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            document.getElementById('displayCurrency1').innerText = base;
            document.getElementById('displayCurrency2').innerText = base;
            document.getElementById('selectionCurrency').innerText = base;

            updateSortIcons();
            // Init toggle style
            setChartMode(selectionChartMode);

            const tbody = document.getElementById('assetTableBody');
            tbody.innerHTML = '';
            
            let sourceAssets = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;

            updateCategoryColors(sourceAssets);

            // Calculate GLOBAL Total Wealth (All assets, ignoring search)
            let globalTotalWealth = 0;
            sourceAssets.forEach(asset => {
                globalTotalWealth += getAssetValueBase(asset, base);
            });
            document.getElementById('displayTotalWealth').innerText = globalTotalWealth.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Filter by Search Query
            const visibleAssets = sourceAssets.filter(asset => 
                asset.category.toLowerCase().includes(searchQuery) || 
                asset.subcategory.toLowerCase().includes(searchQuery)
            );

            // Logic to check/uncheck Master Checkbox based on VISIBLE rows
            const masterCheckbox = document.getElementById('selectAllCheckbox');
            if (visibleAssets.length > 0) {
                const allVisibleSelected = visibleAssets.every(a => selectedIds.has(a.id));
                masterCheckbox.checked = allVisibleSelected;
            } else {
                masterCheckbox.checked = false;
            }

            // Sort Visible Assets
            visibleAssets.sort((a, b) => {
                let valA, valB;
                if (sortState.key === 'valueBase') {
                    valA = getAssetValueBase(a, base);
                    valB = getAssetValueBase(b, base);
                } else if (sortState.key === 'income') {
                    valA = getAssetIncomeBase(a, base);
                    valB = getAssetIncomeBase(b, base);
                } else {
                    valA = a[sortState.key];
                    valB = b[sortState.key];
                }
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            // Render Rows (Visible only)
            let totalMonthlyIncome = 0;
            let categoryTotals = {};
            const cats = new Set();

            // Populate Datalist with ALL categories (for adding new items)
            const allCats = new Set(sourceAssets.map(a => a.category));
            const dl = document.getElementById('catList');
            dl.innerHTML = '';
            allCats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                dl.appendChild(opt);
            });

            visibleAssets.forEach((asset, index) => {
                cats.add(asset.category);
                const valInBase = getAssetValueBase(asset, base);
                
                // Track Category Total (of Visible items)
                if(!categoryTotals[asset.category]) categoryTotals[asset.category] = 0;
                categoryTotals[asset.category] += valInBase;

                const monthlyIncomeBase = getAssetIncomeBase(asset, base);
                totalMonthlyIncome += monthlyIncomeBase;

                const isSelected = selectedIds.has(asset.id);
                const catColor = getCategoryColor(asset.category);
                
                // % of Total (Global Total)
                const percentage = globalTotalWealth > 0 ? ((valInBase / globalTotalWealth) * 100).toFixed(2) + "%" : "0.00%";

                // Ranked Highlighting (on Visible list)
                let rowBg = "row-hover";
                if(index < 3) rowBg = "hl-green";
                else if(index < 10) rowBg = "hl-yellow";

                const tr = document.createElement('tr');
                tr.className = `transition ${rowBg}`;
                tr.innerHTML = `
                    <td class="p-3 text-center">
                        <input type="checkbox" class="cursor-pointer" 
                            onchange="toggleSelect(${asset.id}, this.checked)" 
                            ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="p-3 font-medium text-main cat-cell" onclick="toggleCategory('${asset.category.replace(/'/g, "\\'")}')" title="Click to toggle all ${asset.category} assets">
                        <span style="background-color: ${catColor}" class="w-2.5 h-2.5 rounded-full inline-block mr-2"></span>
                        ${asset.category}
                    </td>
                    <td class="p-3 text-sub">${asset.subcategory}</td>
                    <td class="p-3 text-right text-sub text-xs">${asset.amount.toLocaleString()} ${asset.currency}</td>
                    <td class="p-3 text-right font-bold text-main">${valInBase.toLocaleString(undefined, {maximumFractionDigits:0})} ${base}</td>
                    <td class="p-3 text-right text-sub text-xs font-semibold">${percentage}</td>
                    <td class="p-3 text-right font-bold" style="color: var(--success)">+${monthlyIncomeBase.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td class="p-3 text-center flex justify-center gap-2">
                        <button onclick="startEditAsset(${asset.id})" class="text-blue-400 hover:text-blue-600" title="Edit"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteAsset(${asset.id})" class="text-gray-400 hover:text-red-500" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // If empty search result
            if(visibleAssets.length === 0 && sourceAssets.length > 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-sub">No assets match your search.</td></tr>`;
            }

            document.getElementById('displayTotalIncome').innerText = totalMonthlyIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Update Charts with Visible Data
            renderCharts(categoryTotals);
            
            // Pass GLOBAL total to Selection Chart for % calc
            renderSelectionChart(globalTotalWealth); 
            renderHistoryList();
        }

        // --- CHART RENDERING ---

        function renderSelectionChart(globalTotalWealth) {
            const base = getBaseCurrency();
            const sourceAssets = activeSnapshotId 
                ? appData.history.find(h => h.id === activeSnapshotId).assets 
                : appData.currentAssets;

            // Filter
            const selectedAssets = sourceAssets.filter(a => selectedIds.has(a.id));
            
            let selectionTotal = 0;
            let selectionMonthlyIncome = 0;
            let chartTotals = {};

            selectedAssets.forEach(a => {
                const val = getAssetValueBase(a, base);
                selectionTotal += val;
                
                const incomeBase = getAssetIncomeBase(a, base);
                selectionMonthlyIncome += incomeBase;

                const key = selectionChartMode === 'category' ? a.category : a.subcategory;
                if(!chartTotals[key]) chartTotals[key] = 0;
                chartTotals[key] += val;
            });

            // Update Value Text
            document.getElementById('selectionTotal').innerText = selectionTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Update Share % Text
            let sharePercent = "0.00%";
            if(!globalTotalWealth) { // Safety recalculate if missing
                globalTotalWealth = 0;
                sourceAssets.forEach(a => globalTotalWealth += getAssetValueBase(a, base));
            }
            if(globalTotalWealth > 0) {
                sharePercent = ((selectionTotal / globalTotalWealth) * 100).toFixed(2) + "%";
            }
            document.getElementById('selectionShareText').innerText = `(${sharePercent} of Total Net Worth)`;

            const yearly = selectionMonthlyIncome * 12;
            const daily = yearly / 365;
            document.getElementById('selYearly').innerText = yearly.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " " + base;
            document.getElementById('selDaily').innerText = daily.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " " + base;

            const hint = document.getElementById('selectionHint');
            if(selectedIds.size === 0) {
                hint.classList.remove('hidden');
                if(selectChart) selectChart.clear();
            } else {
                hint.classList.add('hidden');
            }

            const ctx = document.getElementById('selectionChart').getContext('2d');
            
            // SORT BY VALUE DESCENDING
            const sortedEntries = Object.entries(chartTotals).sort((a, b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const data = sortedEntries.map(e => e[1]);

            let colors;
            if (selectionChartMode === 'category') {
                colors = labels.map(l => getCategoryColor(l));
            } else {
                colors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);
            }

            if(selectChart) selectChart.destroy();
            selectChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--bg-card')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 10, font: {size: 9}, color: getComputedStyle(document.body).getPropertyValue('--text-sub') } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + "%";
                                    return context.label + ': ' + value.toLocaleString() + ' ' + base + ' (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCharts(catTotals) {
            const ctxAlloc = document.getElementById('allocationChart').getContext('2d');
            
            // SORT BY VALUE DESCENDING
            const sortedEntries = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const data = sortedEntries.map(e => e[1]);
            
            const colors = labels.map(l => getCategoryColor(l));

            if(allocChart) allocChart.destroy();
            allocChart = new Chart(ctxAlloc, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--bg-card')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 10}, color: getComputedStyle(document.body).getPropertyValue('--text-sub') } } 
                    }
                }
            });

            const ctxHist = document.getElementById('historyChart').getContext('2d');
            const base = getBaseCurrency();

            // Prepare Data
            let histData = [...appData.history];
            let liveTotalUSD = 0;
            appData.currentAssets.forEach(a => {
                const liveRate = appData.liveRates[a.currency];
                const usd = a.amount / liveRate;
                liveTotalUSD += usd;
            });

            let chartPoints = [...histData];
            chartPoints.push({ date: new Date().toISOString(), usdValue: liveTotalUSD, isLive: true });
            
            chartPoints.sort((a,b) => new Date(a.date) - new Date(b.date));

            const histLabels = chartPoints.map(h => h.isLive ? 'Now' : new Date(h.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}));
            
            const histValues = chartPoints.map(h => {
                const valUSD = h.usdValue || 0;
                const rateToUse = appData.liveRates[base] || 1; 
                const valBase = valUSD * rateToUse; 
                return Math.round(valBase * 100) / 100;
            });

            if(histChart) histChart.destroy();
            histChart = new Chart(ctxHist, {
                type: 'line',
                data: {
                    labels: histLabels,
                    datasets: [{
                        label: 'Net Worth',
                        data: histValues,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--accent-color'),
                        backgroundColor: activeSnapshotId ? 'rgba(234, 88, 12, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { 
                            beginAtZero: false, 
                            grid: { color: getComputedStyle(document.body).getPropertyValue('--border-color') },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-sub'),
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', {
                                        notation: "compact",
                                        compactDisplay: "short"
                                    }).format(value);
                                }
                            }
                        },
                        x: { grid: { display: false }, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-sub') } }
                    }
                }
            });
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const base = getBaseCurrency();
            const sortedHist = [...appData.history].sort((a,b) => new Date(b.date) - new Date(a.date));

            sortedHist.forEach(h => {
                const rateToUse = appData.liveRates[base];
                const val = (h.usdValue || 0) * rateToUse;
                
                const isActive = h.id === activeSnapshotId;
                const d = new Date(h.date);
                const dateInputVal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-2 rounded border text-sm transition`;
                // Manual theme handling for history items since they are dynamic
                if(isActive) {
                    div.style.backgroundColor = 'var(--bg-input)';
                    div.style.borderColor = 'var(--accent-color)';
                    div.style.borderWidth = '2px';
                } else {
                    div.style.backgroundColor = 'var(--bg-card)';
                    div.style.borderColor = 'var(--border-color)';
                }
                
                div.innerHTML = `
                    <div class="flex flex-col">
                        <input type="date" value="${dateInputVal}" onchange="updateSnapshotDate(${h.id}, this.value)" class="bg-transparent border-none font-bold text-xs p-0 focus:ring-0 cursor-pointer mb-1 text-main">
                        <div class="text-xs text-sub">${h.assets.length} assets</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-main">${val.toLocaleString(undefined, {maximumFractionDigits:0})} ${base}</span>
                        ${isActive 
                            ? `<span class="text-xs font-bold px-2 py-1 bg-[var(--bg-app)] rounded-full" style="color: var(--accent-color)">Editing</span>`
                            : `<button onclick="enterHistoryMode(${h.id})" class="text-xs font-bold border px-2 py-1 rounded hover:bg-[var(--bg-hover)]" style="color: var(--accent-color); border-color: var(--border-color)">Edit</button>`
                        }
                        ${!isActive ? `<button onclick="deleteHistory(${h.id})" class="text-sub hover:text-red-500"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });

            if(sortedHist.length === 0) {
                list.innerHTML = '<div class="text-center text-xs py-4 text-sub">No history saved yet.</div>';
            }
        }

        function archiveMonth() {
            if(!confirm("Snapshot current assets to history?")) return;
            let totalUSD = 0;
            const currentRates = appData.liveRates; 
            appData.currentAssets.forEach(a => {
                totalUSD += a.amount / currentRates[a.currency];
            });

            const snapshot = {
                id: Date.now(),
                date: new Date().toISOString(),
                usdValue: totalUSD,
                rates: { ...appData.liveRates }, 
                assets: JSON.parse(JSON.stringify(appData.currentAssets))
            };
            appData.history.push(snapshot);
            saveData();
            renderAll();
        }

        function deleteHistory(id) {
            if(!confirm("Delete this snapshot?")) return;
            appData.history = appData.history.filter(h => h.id !== id);
            saveData();
            renderAll();
        }

        // --- IMPORT / EXPORT ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "wealth_data_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(confirm("Overwrite current data?")) {
                        appData = loaded;
                        if(!appData.history) appData.history = [];
                        if(!appData.rates) appData.rates = {...DEFAULT_RATES};
                        if(!appData.liveRates) appData.liveRates = {...appData.rates};
                        if(!appData.presets) appData.presets = [];
                        if(!appData.theme) appData.theme = 'light';
                        
                        saveData();
                        // Apply imported theme
                        setTheme(appData.theme);
                        document.getElementById('themeSelector').value = appData.theme;
                        
                        renderAll();
                        renderPresets();
                    }
                } catch(err) { alert("Invalid JSON"); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
